<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NGC #1105 â€” Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#f0b429;--gold2:#ffd060;--gold-dim:#7a5800;
  --purple:#9b5de5;--blue:#00b4d8;--green:#22c55e;
  --red:#ef4444;--orange:#f97316;--white-seat:#c8d6e0;
  --bg:#06090e;--surface:#0b1118;--surface2:#101820;
  --surface3:#162030;--border:#1a2d42;--border2:#243d58;
  --text:#ccdae8;--dim:#4d7090;--dim2:#7a9ab8;
  --font-d:'Syne',sans-serif;--font-m:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--font-d);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,180,216,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,180,216,.025) 1px,transparent 1px);background-size:50px 50px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold) 30%,var(--blue) 70%,transparent);z-index:100;}
.wrap{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:0 20px 60px;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:20px 0;gap:12px;flex-wrap:wrap;}
.brand{display:flex;align-items:center;gap:14px;}
.brand-icon{width:46px;height:46px;background:linear-gradient(135deg,var(--gold-dim),var(--gold));clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.brand-title{font-size:18px;font-weight:800;letter-spacing:1px;color:#fff;}
.brand-sub{font-family:var(--font-m);font-size:10px;color:var(--dim2);letter-spacing:2px;}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.lang-bar{display:flex;gap:4px;}
.lang-btn{background:var(--surface);border:1px solid var(--border);font-size:18px;padding:4px 8px;cursor:pointer;transition:all .2s;line-height:1;}
.lang-btn:hover{border-color:var(--blue);}
.lang-btn.active{border-color:var(--gold);background:rgba(240,180,41,.1);}
.last-refresh{font-family:var(--font-m);font-size:11px;color:var(--dim);display:flex;align-items:center;gap:6px;}
.refresh-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.btn{font-family:var(--font-d);font-weight:700;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;border:none;padding:9px 20px;transition:all .2s;}
.btn-primary{background:var(--gold);color:#000;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));}
.btn-primary:hover{background:var(--gold2);}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--dim2);}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue);}
.btn-purple{background:transparent;border:1px solid rgba(155,93,229,.4);color:var(--purple);}
.btn-purple:hover{background:rgba(155,93,229,.12);}
.btn-green{background:transparent;border:1px solid rgba(34,197,94,.4);color:var(--green);}
.btn-green:hover{background:rgba(34,197,94,.1);}

/* NAV TABS */
.nav-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:24px;}
.nav-tab{font-family:var(--font-m);font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:12px 22px;border:none;background:transparent;color:var(--dim2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;margin-bottom:24px;}
.kpi{background:var(--surface);border:1px solid var(--border);padding:18px 20px;position:relative;overflow:hidden;}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--kpi-color,var(--blue));opacity:.5;}
.kpi-label{font-family:var(--font-m);font-size:10px;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.kpi-value{font-size:32px;font-weight:800;color:#fff;line-height:1;letter-spacing:-1px;}
.kpi-sub{font-family:var(--font-m);font-size:10px;color:var(--dim2);margin-top:5px;}

/* CHARTS */
.charts-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px;}
@media(max-width:900px){.charts-row{grid-template-columns:1fr 1fr;}}
@media(max-width:580px){.charts-row{grid-template-columns:1fr;}}
.chart-card{background:var(--surface);border:1px solid var(--border);padding:20px;position:relative;}
.chart-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border2),transparent);}
.chart-title{font-family:var(--font-m);font-size:10px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:16px;}
.bar-chart{display:flex;flex-direction:column;gap:8px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-name{font-family:var(--font-m);font-size:10px;color:var(--dim2);width:52px;flex-shrink:0;text-align:right;}
.bar-track{flex:1;height:10px;background:rgba(255,255,255,.04);overflow:hidden;}
.bar-fill{height:100%;transition:width .8s cubic-bezier(.4,0,.2,1);min-width:2px;}
.bar-count{font-family:var(--font-m);font-size:10px;color:var(--text);width:24px;text-align:right;flex-shrink:0;}
.donut-wrap{display:flex;align-items:center;gap:16px;}
.donut-legend{display:flex;flex-direction:column;gap:7px;flex:1;}
.dl-row{display:flex;align-items:center;gap:7px;}
.dl-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dl-label{font-family:var(--font-m);font-size:10px;color:var(--dim2);}
.dl-val{font-family:var(--font-m);font-size:10px;color:var(--text);margin-left:auto;}
.spark-wrap{height:70px;}
.spark-svg{width:100%;height:100%;}

/* FILTERS */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;padding:14px 18px;background:var(--surface);border:1px solid var(--border);margin-bottom:24px;align-items:center;}
.filter-label{font-family:var(--font-m);font-size:10px;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-right:4px;}
.filter-chip{font-family:var(--font-m);font-size:11px;padding:5px 12px;border:1px solid var(--border);background:transparent;color:var(--dim2);cursor:pointer;transition:all .2s;letter-spacing:1px;}
.filter-chip:hover{border-color:var(--blue);color:var(--blue);}
.filter-chip.active{background:rgba(0,180,216,.12);border-color:var(--blue);color:var(--blue);}
.filter-chip.seat-w.active{background:rgba(200,214,224,.1);border-color:var(--white-seat);color:var(--white-seat);}
.filter-chip.seat-b.active{background:rgba(0,180,216,.12);border-color:var(--blue);color:var(--blue);}
.filter-chip.seat-p.active{background:rgba(155,93,229,.12);border-color:var(--purple);color:var(--purple);}
.filter-chip.seat-g.active{background:rgba(240,180,41,.12);border-color:var(--gold);color:var(--gold);}
.filter-sep{width:1px;height:22px;background:var(--border);margin:0 6px;}
select.filter-select{font-family:var(--font-m);font-size:11px;background:var(--bg);border:1px solid var(--border);color:var(--dim2);padding:5px 28px 5px 10px;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath fill='%234d7090' d='M5 7L0 0h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;outline:none;transition:border-color .2s;}
select.filter-select:focus{border-color:var(--blue);}
select.filter-select option{background:var(--surface2);}

/* TABLE */
.table-card{background:var(--surface);border:1px solid var(--border);overflow:hidden;}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;}
.table-title{font-size:13px;font-weight:700;letter-spacing:1px;color:#fff;}
.table-count{font-family:var(--font-m);font-size:11px;color:var(--dim2);margin-left:8px;}
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{font-family:var(--font-m);font-size:10px;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;}
thead th:hover{color:var(--blue);}
.sort-ico{font-size:9px;margin-left:4px;opacity:.6;}
tbody tr{border-bottom:1px solid rgba(26,45,66,.5);transition:background .15s;}
tbody tr:hover{background:rgba(255,255,255,.025);}
tbody tr:last-child{border-bottom:none;}
tbody td{padding:11px 14px;vertical-align:middle;}
.td-nick{font-weight:700;color:#fff;}
.td-server,.td-ts{font-family:var(--font-m);font-size:10px;color:var(--dim);}
.td-power{font-family:var(--font-m);font-size:12px;}
.seat-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;font-family:var(--font-m);font-size:10px;letter-spacing:1px;text-transform:uppercase;border:1px solid;}
.sb-w{color:var(--white-seat);border-color:rgba(200,214,224,.3);background:rgba(200,214,224,.05);}
.sb-b{color:var(--blue);border-color:rgba(0,180,216,.3);background:rgba(0,180,216,.06);}
.sb-p{color:var(--purple);border-color:rgba(155,93,229,.3);background:rgba(155,93,229,.06);}
.sb-g{color:var(--gold);border-color:rgba(240,180,41,.3);background:rgba(240,180,41,.06);}
.status-badge{display:inline-block;padding:3px 9px;font-family:var(--font-m);font-size:10px;letter-spacing:1px;}
.st-wait{color:var(--orange);background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.25);}
.st-ok{color:var(--green);background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);}
.st-no{color:var(--red);background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);}
.st-rev{color:var(--blue);background:rgba(0,180,216,.1);border:1px solid rgba(0,180,216,.25);}
.ally-tag{font-family:var(--font-m);font-size:11px;font-weight:500;color:var(--gold);}
.act-btn{font-family:var(--font-m);font-size:10px;padding:3px 8px;border:1px solid var(--border);background:transparent;color:var(--dim2);cursor:pointer;transition:all .15s;}
.act-btn:hover{border-color:var(--green);color:var(--green);}
.state-row{text-align:center;padding:40px;color:var(--dim);}
.spinner{display:inline-block;width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface2);border:1px solid var(--border2);padding:28px;max-width:540px;width:100%;position:relative;animation:fadeUp .25s ease;clip-path:polygon(0 0,calc(100% - 14px) 0,100% 14px,100% 100%,14px 100%,0 calc(100% - 14px));}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.modal-title{font-size:16px;font-weight:800;color:#fff;margin-bottom:20px;}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;}
.modal-close:hover{color:var(--text);}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.detail-item{background:var(--surface);padding:12px 14px;border:1px solid var(--border);}
.detail-key{font-family:var(--font-m);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:5px;}
.detail-val{font-size:14px;font-weight:600;color:var(--text);}
.detail-item.full{grid-column:1/-1;}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;}
.mact{font-family:var(--font-d);font-weight:700;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;padding:10px 20px;border:1px solid;cursor:pointer;background:transparent;}
.mact-ok{color:var(--green);border-color:rgba(34,197,94,.4);}
.mact-ok:hover{background:rgba(34,197,94,.1);}
.mact-no{color:var(--red);border-color:rgba(239,68,68,.4);}
.mact-no:hover{background:rgba(239,68,68,.1);}
.mact-rev{color:var(--blue);border-color:rgba(0,180,216,.4);}
.mact-rev:hover{background:rgba(0,180,216,.1);}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:300;background:var(--surface2);border:1px solid var(--border2);padding:12px 20px;font-size:13px;font-weight:600;display:none;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));}
.toast.show{display:block;}

/* EDITOR */
.editor-intro{font-family:var(--font-m);font-size:12px;color:var(--dim2);line-height:1.7;margin-bottom:24px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--gold);}
.editor-intro em{color:var(--gold);font-style:normal;}
.ally-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px;}
.ally-tab{font-family:var(--font-m);font-size:10px;letter-spacing:1px;padding:6px 14px;border:1px solid var(--border);background:transparent;color:var(--dim2);cursor:pointer;transition:all .2s;}
.ally-tab:hover{border-color:var(--purple);color:var(--purple);}
.ally-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(240,180,41,.08);}
.editor-card{background:var(--surface);border:1px solid var(--border);padding:24px;position:relative;}
.editor-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--purple),transparent);}
.editor-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
.editor-tag{font-family:var(--font-m);font-size:18px;font-weight:700;color:var(--gold);}
.editor-fullname{font-size:15px;color:var(--dim2);}
.editor-rank{font-family:var(--font-m);font-size:11px;color:var(--dim);padding:4px 10px;border:1px solid var(--border);}
.source-block{margin-bottom:20px;}
.source-label{font-family:var(--font-m);font-size:10px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;}
.source-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
textarea.src-input{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-d);font-size:13px;padding:12px 14px;width:100%;min-height:72px;resize:vertical;outline:none;line-height:1.5;transition:border-color .2s;}
textarea.src-input:focus{border-color:var(--purple);}
.src-field-label{font-family:var(--font-m);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:5px;}
.translate-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.translate-status{font-family:var(--font-m);font-size:11px;color:var(--dim);flex:1;}
.translate-status.loading{color:var(--blue);}
.translate-status.done{color:var(--green);}
.translate-status.err{color:var(--red);}
.translations-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
@media(max-width:700px){.translations-grid{grid-template-columns:1fr;}.source-row{grid-template-columns:1fr;}}
.trans-card{background:var(--bg);border:1px solid var(--border);padding:16px;transition:border-color .2s;}
.trans-card.has-content{border-color:var(--border2);}
.trans-card-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.trans-flag{font-size:18px;}
.trans-lang{font-family:var(--font-m);font-size:10px;letter-spacing:2px;color:var(--dim2);text-transform:uppercase;}
.trans-field{margin-bottom:8px;}
.trans-field-label{font-family:var(--font-m);font-size:9px;letter-spacing:1px;color:var(--dim);text-transform:uppercase;margin-bottom:3px;}
.trans-field-text{font-size:12px;color:var(--text);line-height:1.5;}
.trans-empty{color:var(--dim);font-style:italic;font-size:12px;}
textarea.trans-edit{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-d);font-size:12px;padding:8px 10px;width:100%;min-height:52px;resize:vertical;outline:none;line-height:1.5;}
textarea.trans-edit:focus{border-color:var(--blue);}
.save-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 0 0;border-top:1px solid var(--border);flex-wrap:wrap;gap:10px;}
.save-info{font-family:var(--font-m);font-size:10px;color:var(--dim);}
.last-saved{font-family:var(--font-m);font-size:10px;color:var(--dim);margin-top:4px;}
.save-actions{display:flex;gap:8px;}

@media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr);}.detail-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-icon">âš”</div>
      <div>
        <div class="brand-title">COMMAND CENTER</div>
        <div class="brand-sub">NGC #1105 Â· TRANSFER SURGE</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="lang-bar">
        <button class="lang-btn active" onclick="setLang('it')" title="Italiano">ğŸ‡®ğŸ‡¹</button>
        <button class="lang-btn" onclick="setLang('fr')" title="FranÃ§ais">ğŸ‡«ğŸ‡·</button>
        <button class="lang-btn" onclick="setLang('en')" title="English">ğŸ‡¬ğŸ‡§</button>
        <button class="lang-btn" onclick="setLang('de')" title="Deutsch">ğŸ‡©ğŸ‡ª</button>
      </div>
      <div class="last-refresh"><span class="refresh-dot"></span><span id="refreshLabel">...</span></div>
      <button class="btn btn-primary" onclick="loadData()" id="btnRefresh">â†»</button>
    </div>
  </div>

  <!-- NAV TABS -->
  <div class="nav-tabs">
    <button class="nav-tab active" id="tabBtnStats" onclick="showTab('Stats')" id="tabBtnStats">ğŸ“Š <span data-t="tabStats"></span></button>
    <button class="nav-tab" id="tabBtnEditor" onclick="showTab('Editor')">âœï¸ <span data-t="tabEditor"></span></button>
  </div>

  <!-- â•â•â• TAB STATS â•â•â• -->
  <div id="tabStats">
    <div class="kpi-row">
      <div class="kpi" style="--kpi-color:var(--blue)"><div class="kpi-label" data-t="kpiTotalLabel"></div><div class="kpi-value" id="kpiTotal">â€”</div><div class="kpi-sub" data-t="kpiTotalSub"></div></div>
      <div class="kpi" style="--kpi-color:var(--orange)"><div class="kpi-label" data-t="kpiWaitLabel"></div><div class="kpi-value" id="kpiWait">â€”</div><div class="kpi-sub" data-t="kpiWaitSub"></div></div>
      <div class="kpi" style="--kpi-color:var(--green)"><div class="kpi-label" data-t="kpiOkLabel"></div><div class="kpi-value" id="kpiOk">â€”</div><div class="kpi-sub" data-t="kpiOkSub"></div></div>
      <div class="kpi" style="--kpi-color:var(--gold)"><div class="kpi-label" data-t="kpiEliteLabel"></div><div class="kpi-value" id="kpiElite">â€”</div><div class="kpi-sub" data-t="kpiEliteSub"></div></div>
      <div class="kpi" style="--kpi-color:var(--purple)"><div class="kpi-label" data-t="kpiContribLabel"></div><div class="kpi-value" id="kpiContrib">â€”</div><div class="kpi-sub" data-t="kpiContribSub"></div></div>
      <div class="kpi" style="--kpi-color:var(--blue)"><div class="kpi-label" data-t="kpiLangsLabel"></div><div class="kpi-value" id="kpiLangs">â€”</div><div class="kpi-sub" data-t="kpiLangsSub"></div></div>
    </div>
    <div class="charts-row">
      <div class="chart-card"><div class="chart-title" data-t="chartAllianceTitle"></div><div class="bar-chart" id="chartAlliance"></div></div>
      <div class="chart-card"><div class="chart-title" data-t="chartSeatTitle"></div><div class="donut-wrap"><svg id="donutSvg" width="100" height="100" viewBox="0 0 100 100"></svg><div class="donut-legend" id="donutLegend"></div></div></div>
      <div class="chart-card"><div class="chart-title" data-t="chartTimeTitle"></div><div class="spark-wrap"><svg class="spark-svg" id="sparkSvg" viewBox="0 0 200 70" preserveAspectRatio="none"></svg></div><div id="sparkLabels" style="display:flex;justify-content:space-between;margin-top:4px;"></div></div>
    </div>
    <div class="filter-bar">
      <span class="filter-label" data-t="filterSeat"></span>
      <button class="filter-chip active" data-filter="seat" data-val="all" onclick="setFilter('seat','all',this)" data-t-text="filterAll"></button>
      <button class="filter-chip seat-w" data-filter="seat" data-val="FOLLOWER" onclick="setFilter('seat','FOLLOWER',this)">â¬œ Follower</button>
      <button class="filter-chip seat-b" data-filter="seat" data-val="PIONEER" onclick="setFilter('seat','PIONEER',this)">ğŸ”µ Pioneer</button>
      <button class="filter-chip seat-p" data-filter="seat" data-val="CONTRIBUTOR" onclick="setFilter('seat','CONTRIBUTOR',this)">ğŸŸ£ Contributor</button>
      <button class="filter-chip seat-g" data-filter="seat" data-val="ELITE" onclick="setFilter('seat','ELITE',this)">ğŸ‘‘ Elite</button>
      <div class="filter-sep"></div>
      <span class="filter-label" data-t="filterAlly"></span>
      <select class="filter-select" id="filterAlliance" onchange="setFilter('alliance',this.value)"><option value="all" data-t-text="filterAll"></option></select>
      <div class="filter-sep"></div>
      <span class="filter-label" data-t="filterStatus"></span>
      <select class="filter-select" id="filterStatus" onchange="setFilter('status',this.value)">
        <option value="all" data-t-text="filterAll"></option>
        <option value="In attesa" data-t-text="stWait"></option>
        <option value="Accettato" data-t-text="stOk"></option>
        <option value="Rifiutato" data-t-text="stNo"></option>
        <option value="In valutazione" data-t-text="stRev"></option>
      </select>
      <div class="filter-sep"></div>
      <input type="text" id="searchInput" style="background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-m);font-size:11px;padding:5px 12px;outline:none;" oninput="renderTable()" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border)'" data-t-placeholder="searchPh">
    </div>
    <div class="table-card">
      <div class="table-header">
        <div><span class="table-title" data-t="tableTitle"></span><span class="table-count" id="tableCount"></span></div>
        <button class="btn btn-ghost" style="font-size:11px;padding:7px 14px;" onclick="exportCSV()" data-t-text="btnCsv"></button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th onclick="sortBy('ts')">#</th>
            <th onclick="sortBy('nickname')" data-t="thNick"></th>
            <th onclick="sortBy('power')" data-t="thPower"></th>
            <th data-t="thServer"></th>
            <th data-t="thSeat"></th>
            <th data-t="thAlly"></th>
            <th onclick="sortBy('status')" data-t="thStatus"></th>
            <th data-t="thActions"></th>
          </tr></thead>
          <tbody id="tableBody"><tr><td colspan="8" class="state-row"><div class="spinner"></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â•â• TAB EDITOR â•â•â• -->
  <div id="tabEditor" style="display:none;">
    <div class="editor-intro" data-t-html="editorIntro"></div>
    <div class="ally-tabs" id="allyTabsRow"></div>
    <div class="editor-card">
      <div class="editor-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="editor-tag" id="edTag"></span>
          <span class="editor-fullname" id="edName"></span>
        </div>
        <span class="editor-rank" id="edRank"></span>
      </div>
      <div class="source-block">
        <div class="source-label">
          <span>ğŸ‡®ğŸ‡¹ <span data-t="srcLangLabel"></span></span>
          <span style="font-size:9px;color:var(--dim)" data-t="srcHint"></span>
        </div>
        <div class="source-row">
          <div><div class="src-field-label" data-t="srcReqLabel"></div><textarea class="src-input" id="srcReq" rows="2"></textarea></div>
          <div><div class="src-field-label" data-t="srcDescLabel"></div><textarea class="src-input" id="srcDesc" rows="2"></textarea></div>
        </div>
      </div>
      <div class="translate-bar">
        <button class="btn btn-purple" id="btnTranslate" onclick="translateAll()" data-t-text="btnTranslate"></button>
        <div class="translate-status" id="translateStatus" data-t="translateWaiting"></div>
      </div>
      <div class="translations-grid" id="transGrid"></div>
      <div class="save-bar">
        <div>
          <div class="save-info" id="saveInfo" data-t="saveInfo"></div>
          <div class="last-saved" id="lastSaved"></div>
        </div>
        <div class="save-actions">
          <button class="btn btn-ghost" onclick="resetEditor()" data-t-text="btnReset"></button>
          <button class="btn btn-green" onclick="saveAllianceTexts()" data-t-text="btnSave"></button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /wrap -->

<!-- MODAL -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal-title" id="modalTitle"></div>
    <div class="detail-grid" id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwO03mROK8NNru3R-6w4y8vmA48_bAWYSflnseYLm__ThQkO0s7G0Uel9asZKlTROWN/exec';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSLATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UI = {
  it:{
    tabStats:'Statistiche', tabEditor:'Editor Alleanze',
    btnRefresh:'â†» Aggiorna',
    kpiTotalLabel:'Totale', kpiTotalSub:'candidature ricevute',
    kpiWaitLabel:'In Attesa', kpiWaitSub:'da elaborare',
    kpiOkLabel:'Accettati', kpiOkSub:'approvati',
    kpiEliteLabel:'Elite ğŸ‘‘', kpiEliteSub:'sedia oro',
    kpiContribLabel:'Contributor', kpiContribSub:'sedia viola',
    kpiLangsLabel:'Lingue', kpiLangsSub:'diverse',
    chartAllianceTitle:'Candidature per Alleanza',
    chartSeatTitle:'Distribuzione Sedie',
    chartTimeTitle:'Ultimi 7 Giorni',
    filterSeat:'Sedia', filterAlly:'Alleanza', filterStatus:'Stato',
    filterAll:'Tutte', searchPh:'ğŸ” cerca nickname...',
    tableTitle:'CANDIDATURE', btnCsv:'â†“ CSV',
    thNick:'Nickname', thPower:'Potenza', thServer:'Server',
    thSeat:'Sedia', thAlly:'Alleanza', thStatus:'Stato', thActions:'Azioni',
    stWait:'In attesa', stOk:'Accettato', stNo:'Rifiutato', stRev:'In valutazione',
    btnDetails:'ğŸ‘ Dettagli',
    modalPower:'Potenza', modalSeat:'Sedia', modalServer:'Server',
    modalLang:'Lingua', modalAlly:'Alleanza', modalIntent:'Vuole #1105',
    modalBio:'Presentazione', modalStatus:'Stato', modalNotes:'Note Leader', modalDate:'Ricevuta il',
    modalNoBio:'Nessuna', modalNoNotes:'Nessuna nota',
    intentMap:{yes_sure:'SÃ¬!', interested:'Vuole info', maybe:'Forse', no:'No'},
    btnAccept:'âœ“ Accetta', btnReject:'âœ— Rifiuta', btnReview:'âŸ³ In valutazione',
    editorIntro:'<em>Come funziona:</em> scrivi il testo in italiano (requisiti + descrizione), poi clicca <em>Traduci automaticamente</em> â€” il sistema genera le 4 versioni linguistiche. Puoi rifinire ogni traduzione prima di salvare.',
    srcLangLabel:'Testo sorgente (italiano)', srcHint:'Scrivi qui Â· sarÃ  tradotto nelle altre lingue',
    srcReqLabel:'Requisiti di accesso', srcDescLabel:'Descrizione alleanza',
    btnTranslate:'ğŸŒ Traduci automaticamente', translateWaiting:'In attesa del testo sorgente...',
    translateLoading:'Traduzione in corso...', translateDone:'âœ… Traduzione completata',
    saveInfo:'Modifica i testi poi salva', btnReset:'â†º Ripristina', btnSave:'ğŸ’¾ Salva sul Sheet',
    noData:'Nessuna candidatura trovata',
    refreshed:'Aggiornato Â·', refreshError:'âš  Errore',
  },
  fr:{
    tabStats:'Statistiques', tabEditor:'Ã‰diteur Alliances',
    btnRefresh:'â†» Actualiser',
    kpiTotalLabel:'Total', kpiTotalSub:'candidatures reÃ§ues',
    kpiWaitLabel:'En Attente', kpiWaitSub:'Ã  traiter',
    kpiOkLabel:'AcceptÃ©s', kpiOkSub:'approuvÃ©s',
    kpiEliteLabel:'Ã‰lite ğŸ‘‘', kpiEliteSub:'siÃ¨ge or',
    kpiContribLabel:'Contributor', kpiContribSub:'siÃ¨ge violet',
    kpiLangsLabel:'Langues', kpiLangsSub:'diffÃ©rentes',
    chartAllianceTitle:'Candidatures par Alliance',
    chartSeatTitle:'Distribution des SiÃ¨ges',
    chartTimeTitle:'7 Derniers Jours',
    filterSeat:'SiÃ¨ge', filterAlly:'Alliance', filterStatus:'Statut',
    filterAll:'Tous', searchPh:'ğŸ” chercher pseudo...',
    tableTitle:'CANDIDATURES', btnCsv:'â†“ CSV',
    thNick:'Pseudo', thPower:'Puissance', thServer:'Serveur',
    thSeat:'SiÃ¨ge', thAlly:'Alliance', thStatus:'Statut', thActions:'Actions',
    stWait:'En attente', stOk:'AcceptÃ©', stNo:'RefusÃ©', stRev:'En Ã©valuation',
    btnDetails:'ğŸ‘ DÃ©tails',
    modalPower:'Puissance', modalSeat:'SiÃ¨ge', modalServer:'Serveur',
    modalLang:'Langue', modalAlly:'Alliance', modalIntent:'Veut #1105',
    modalBio:'PrÃ©sentation', modalStatus:'Statut', modalNotes:'Notes Leader', modalDate:'ReÃ§u le',
    modalNoBio:'Aucune', modalNoNotes:'Aucune note',
    intentMap:{yes_sure:'Oui !', interested:'Veut infos', maybe:'Peut-Ãªtre', no:'Non'},
    btnAccept:'âœ“ Accepter', btnReject:'âœ— Refuser', btnReview:'âŸ³ En Ã©valuation',
    editorIntro:'<em>Comment Ã§a marche :</em> Ã©cris le texte en italien (exigences + description), puis clique <em>Traduire automatiquement</em> â€” le systÃ¨me gÃ©nÃ¨re les 4 versions linguistiques.',
    srcLangLabel:'Texte source (italien)', srcHint:'Ã‰cris ici Â· sera traduit dans les autres langues',
    srcReqLabel:'Conditions d\'accÃ¨s', srcDescLabel:'Description de l\'alliance',
    btnTranslate:'ğŸŒ Traduire automatiquement', translateWaiting:'En attente du texte source...',
    translateLoading:'Traduction en cours...', translateDone:'âœ… Traduction terminÃ©e',
    saveInfo:'Modifie les textes puis sauvegarde', btnReset:'â†º RÃ©initialiser', btnSave:'ğŸ’¾ Sauvegarder',
    noData:'Aucune candidature trouvÃ©e',
    refreshed:'Mis Ã  jour Â·', refreshError:'âš  Erreur',
  },
  en:{
    tabStats:'Statistics', tabEditor:'Alliance Editor',
    btnRefresh:'â†» Refresh',
    kpiTotalLabel:'Total', kpiTotalSub:'applications received',
    kpiWaitLabel:'Pending', kpiWaitSub:'to review',
    kpiOkLabel:'Accepted', kpiOkSub:'approved',
    kpiEliteLabel:'Elite ğŸ‘‘', kpiEliteSub:'gold seat',
    kpiContribLabel:'Contributor', kpiContribSub:'purple seat',
    kpiLangsLabel:'Languages', kpiLangsSub:'different',
    chartAllianceTitle:'Applications by Alliance',
    chartSeatTitle:'Seat Distribution',
    chartTimeTitle:'Last 7 Days',
    filterSeat:'Seat', filterAlly:'Alliance', filterStatus:'Status',
    filterAll:'All', searchPh:'ğŸ” search nickname...',
    tableTitle:'APPLICATIONS', btnCsv:'â†“ CSV',
    thNick:'Nickname', thPower:'Power', thServer:'Server',
    thSeat:'Seat', thAlly:'Alliance', thStatus:'Status', thActions:'Actions',
    stWait:'Pending', stOk:'Accepted', stNo:'Rejected', stRev:'Under review',
    btnDetails:'ğŸ‘ Details',
    modalPower:'Power', modalSeat:'Seat', modalServer:'Server',
    modalLang:'Language', modalAlly:'Alliance', modalIntent:'Wants #1105',
    modalBio:'Presentation', modalStatus:'Status', modalNotes:'Leader Notes', modalDate:'Received on',
    modalNoBio:'None', modalNoNotes:'No notes',
    intentMap:{yes_sure:'Yes!', interested:'Wants info', maybe:'Maybe', no:'No'},
    btnAccept:'âœ“ Accept', btnReject:'âœ— Reject', btnReview:'âŸ³ Under review',
    editorIntro:'<em>How it works:</em> write the text in Italian (requirements + description), then click <em>Auto-translate</em> â€” the system generates all 4 language versions.',
    srcLangLabel:'Source text (Italian)', srcHint:'Write here Â· will be translated into other languages',
    srcReqLabel:'Access requirements', srcDescLabel:'Alliance description',
    btnTranslate:'ğŸŒ Auto-translate', translateWaiting:'Waiting for source text...',
    translateLoading:'Translating...', translateDone:'âœ… Translation complete',
    saveInfo:'Edit texts then save', btnReset:'â†º Reset', btnSave:'ğŸ’¾ Save to Sheet',
    noData:'No applications found',
    refreshed:'Updated Â·', refreshError:'âš  Error',
  },
  de:{
    tabStats:'Statistiken', tabEditor:'Allianz-Editor',
    btnRefresh:'â†» Aktualisieren',
    kpiTotalLabel:'Gesamt', kpiTotalSub:'Bewerbungen erhalten',
    kpiWaitLabel:'Ausstehend', kpiWaitSub:'zu bearbeiten',
    kpiOkLabel:'Akzeptiert', kpiOkSub:'genehmigt',
    kpiEliteLabel:'Elite ğŸ‘‘', kpiEliteSub:'Gold-Sitz',
    kpiContribLabel:'Contributor', kpiContribSub:'Lila-Sitz',
    kpiLangsLabel:'Sprachen', kpiLangsSub:'verschiedene',
    chartAllianceTitle:'Bewerbungen je Allianz',
    chartSeatTitle:'Sitzverteilung',
    chartTimeTitle:'Letzte 7 Tage',
    filterSeat:'Sitz', filterAlly:'Allianz', filterStatus:'Status',
    filterAll:'Alle', searchPh:'ğŸ” Nickname suchen...',
    tableTitle:'BEWERBUNGEN', btnCsv:'â†“ CSV',
    thNick:'Nickname', thPower:'StÃ¤rke', thServer:'Server',
    thSeat:'Sitz', thAlly:'Allianz', thStatus:'Status', thActions:'Aktionen',
    stWait:'Ausstehend', stOk:'Akzeptiert', stNo:'Abgelehnt', stRev:'In PrÃ¼fung',
    btnDetails:'ğŸ‘ Details',
    modalPower:'StÃ¤rke', modalSeat:'Sitz', modalServer:'Server',
    modalLang:'Sprache', modalAlly:'Allianz', modalIntent:'Will #1105',
    modalBio:'Vorstellung', modalStatus:'Status', modalNotes:'Leader-Notizen', modalDate:'Erhalten am',
    modalNoBio:'Keine', modalNoNotes:'Keine Notizen',
    intentMap:{yes_sure:'Ja!', interested:'Will Infos', maybe:'Vielleicht', no:'Nein'},
    btnAccept:'âœ“ Akzeptieren', btnReject:'âœ— Ablehnen', btnReview:'âŸ³ In PrÃ¼fung',
    editorIntro:'<em>So funktioniert es:</em> Schreib den Text auf Italienisch (Anforderungen + Beschreibung), dann klicke <em>Automatisch Ã¼bersetzen</em> â€” das System erstellt alle 4 Sprachversionen.',
    srcLangLabel:'Quelltext (Italienisch)', srcHint:'Hier schreiben Â· wird in andere Sprachen Ã¼bersetzt',
    srcReqLabel:'Zugangsbedingungen', srcDescLabel:'Allianz-Beschreibung',
    btnTranslate:'ğŸŒ Automatisch Ã¼bersetzen', translateWaiting:'Warte auf Quelltext...',
    translateLoading:'Ãœbersetzung lÃ¤uft...', translateDone:'âœ… Ãœbersetzung abgeschlossen',
    saveInfo:'Texte bearbeiten dann speichern', btnReset:'â†º ZurÃ¼cksetzen', btnSave:'ğŸ’¾ Im Sheet speichern',
    noData:'Keine Bewerbungen gefunden',
    refreshed:'Aktualisiert Â·', refreshError:'âš  Fehler',
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANG ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lang = 'it';
const LANG_CODES = ['it','fr','en','de'];

function setLang(l) {
  lang = l;
  document.documentElement.lang = l;
  document.querySelectorAll('.lang-btn').forEach((b,i) => b.classList.toggle('active', LANG_CODES[i] === l));
  const t = UI[l];

  // data-t â†’ textContent
  document.querySelectorAll('[data-t]').forEach(el => {
    const key = el.getAttribute('data-t');
    if (t[key] !== undefined) el.textContent = t[key];
  });
  // data-t-html â†’ innerHTML
  document.querySelectorAll('[data-t-html]').forEach(el => {
    const key = el.getAttribute('data-t-html');
    if (t[key] !== undefined) el.innerHTML = t[key];
  });
  // data-t-text (buttons, options) â†’ textContent
  document.querySelectorAll('[data-t-text]').forEach(el => {
    const key = el.getAttribute('data-t-text');
    if (t[key] !== undefined) el.textContent = t[key];
  });
  // data-t-placeholder
  document.querySelectorAll('[data-t-placeholder]').forEach(el => {
    const key = el.getAttribute('data-t-placeholder');
    if (t[key] !== undefined) el.placeholder = t[key];
  });

  // Tab labels (button contains span with data-t)
  document.querySelector('#tabBtnStats span[data-t]').textContent = t.tabStats;
  document.querySelector('#tabBtnEditor span[data-t]').textContent = t.tabEditor;

  // Status filter options â€” need to repopulate with translated values
  const fs = document.getElementById('filterStatus');
  if (fs) {
    fs.options[0].textContent = t.filterAll;
    fs.options[1].textContent = t.stWait;
    fs.options[2].textContent = t.stOk;
    fs.options[3].textContent = t.stNo;
    fs.options[4].textContent = t.stRev;
  }

  // Alliance filter "all" option
  const fa = document.getElementById('filterAlliance');
  if (fa && fa.options[0]) fa.options[0].textContent = t.filterAll;

  // Re-render dynamic content
  if (allRows.length) { renderTable(); updateKPIs(); }
  if (document.getElementById('tabEditor').style.display !== 'none') renderEditorCard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALLIANCES = [
  {tag:'NgC',name:'Night Commando',rank:'#1 Â· 20.4B'},
  {tag:'DJN',name:'THE RISE',rank:'#2 Â· 17.9B'},
  {tag:'VNEM',name:'True Unity',rank:'#3 Â· 17.3B'},
  {tag:'LdKy',name:'GottisUnitedKnights',rank:'#4 Â· 15.6B'},
  {tag:'FmLy',name:'Family01',rank:'#5 Â· 14.1B'},
  {tag:'BwF',name:'Better with Family',rank:'#6 Â· 13.9B'},
  {tag:'CZNS',name:'CheZ NouS',rank:'#8 Â· 12.3B'},
  {tag:'GLDY',name:'GLADÄ°ATORS',rank:'#9 Â· 8.3B'},
];
const LANGS_EDITOR = [
  {code:'it',flag:'ğŸ‡®ğŸ‡¹',label:'Italiano'},
  {code:'fr',flag:'ğŸ‡«ğŸ‡·',label:'FranÃ§ais'},
  {code:'en',flag:'ğŸ‡¬ğŸ‡§',label:'English'},
  {code:'de',flag:'ğŸ‡©ğŸ‡ª',label:'Deutsch'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allRows = [];
let allianceTexts = {};
let filters = {seat:'all', alliance:'all', status:'all'};
let sortCol = 'ts', sortAsc = false;
let currentAllyTag = ALLIANCES[0].tag;
let unsavedChanges = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name) {
  document.getElementById('tabStats').style.display  = name==='Stats'  ? 'block' : 'none';
  document.getElementById('tabEditor').style.display = name==='Editor' ? 'block' : 'none';
  document.getElementById('tabBtnStats').classList.toggle('active',  name==='Stats');
  document.getElementById('tabBtnEditor').classList.toggle('active', name==='Editor');
  if (name==='Editor') initEditor();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO = [
  {ts:'2026-02-20 14:32',lang:'it',nickname:'DarkHunter88',power:220000000,server:'#1080',seat:'ELITE âš¡',intent:'yes_sure',alliance:'NgC',allianceName:'Night Commando',bio:'Top player, 5 stelle.',status:'In attesa',notes:''},
  {ts:'2026-02-20 16:11',lang:'fr',nickname:'Soleil77',power:95000000,server:'#1091',seat:'CONTRIBUTOR',intent:'yes_sure',alliance:'DJN',allianceName:'THE RISE',bio:'Joueur actif.',status:'In attesa',notes:''},
  {ts:'2026-02-21 09:05',lang:'en',nickname:'IronFist',power:55000000,server:'#1078',seat:'PIONEER',intent:'maybe',alliance:'VNEM',allianceName:'True Unity',bio:'Looking for active alliance.',status:'Accettato',notes:''},
  {ts:'2026-02-21 11:22',lang:'de',nickname:'Sturm99',power:185000000,server:'#1083',seat:'ELITE âš¡',intent:'yes_sure',alliance:'NgC',allianceName:'Night Commando',bio:'Sehr aktiv, T10.',status:'In valutazione',notes:'Contattato'},
  {ts:'2026-02-21 14:44',lang:'it',nickname:'LupoCacciatore',power:28000000,server:'#1095',seat:'FOLLOWER',intent:'no',alliance:'GLDY',allianceName:'GLADÄ°ATORS',bio:'',status:'In attesa',notes:''},
  {ts:'2026-02-22 08:30',lang:'fr',nickname:'Chevalier_X',power:130000000,server:'#1088',seat:'CONTRIBUTOR',intent:'yes_sure',alliance:'LdKy',allianceName:'GottisUnitedKnights',bio:'Alliance chevaliÃ¨re.',status:'Rifiutato',notes:'Slot pieno'},
  {ts:'2026-02-22 10:15',lang:'it',nickname:'NightWolf',power:62000000,server:'#1079',seat:'PIONEER',intent:'yes_sure',alliance:'FmLy',allianceName:'Family01',bio:'Cerco alleanza attiva.',status:'In attesa',notes:''},
  {ts:'2026-02-22 13:00',lang:'en',nickname:'StrikeForce',power:310000000,server:'#1076',seat:'ELITE âš¡',intent:'yes_sure',alliance:'NgC',allianceName:'Night Commando',bio:'',status:'Accettato',notes:''},
];

async function loadData() {
  const t = UI[lang];
  document.getElementById('refreshLabel').textContent = t.translateLoading || '...';
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" class="state-row"><div class="spinner"></div></td></tr>';

  try {
    const res  = await fetch(SCRIPT_URL + '?action=getAll&t=' + Date.now());
    const text = await res.text();
    const json = JSON.parse(text);
    if (!json.success) throw new Error(json.error);

    allRows = (json.rows||[]).map((r,i) => ({
      _id:i, ts:r[0]||'', lang:r[1]||'', nickname:r[2]||'',
      power:parseInt(r[3])||0, server:r[4]||'', seat:r[5]||'',
      intent:r[6]||'', alliance:r[7]||'', allianceName:r[8]||'',
      bio:r[9]||'', status:r[10]||'In attesa', notes:r[11]||'',
    }));
    if (json.allianceTexts) allianceTexts = json.allianceTexts;

    document.getElementById('refreshLabel').textContent = t.refreshed + ' ' + new Date().toLocaleTimeString();
    processData();
  } catch(err) {
    // Fallback to demo
    allRows = DEMO.map((r,i) => ({...r, _id:i}));
    document.getElementById('refreshLabel').textContent = 'âš  Demo';
    processData();
  }
}

function processData() {
  updateKPIs(); buildAllianceFilter(); buildChartAlliance(); buildDonut(); buildSparkline(); renderTable();
}

function updateKPIs() {
  set('kpiTotal',   allRows.length);
  set('kpiWait',    allRows.filter(x=>x.status==='In attesa').length);
  set('kpiOk',      allRows.filter(x=>x.status==='Accettato').length);
  set('kpiElite',   allRows.filter(x=>seatKey(x.seat)==='g').length);
  set('kpiContrib', allRows.filter(x=>seatKey(x.seat)==='p').length);
  set('kpiLangs',   new Set(allRows.map(x=>x.lang).filter(Boolean)).size);
}

function buildAllianceFilter() {
  const sel=document.getElementById('filterAlliance'), cur=sel.value;
  while(sel.options.length>1) sel.remove(1);
  [...new Set(allRows.map(r=>r.alliance).filter(Boolean))].sort().forEach(tag=>{
    const o=document.createElement('option'); o.value=tag; o.textContent=`[${tag}]`; sel.appendChild(o);
  });
  sel.value=cur;
  if(sel.options[0]) sel.options[0].textContent = UI[lang].filterAll;
}

function buildChartAlliance() {
  const counts={};
  allRows.forEach(r=>{if(r.alliance)counts[r.alliance]=(counts[r.alliance]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const max=sorted[0]?.[1]||1;
  const colors={NgC:'#f0b429',DJN:'#ffd060',VNEM:'#9b5de5',LdKy:'#00b4d8',FmLy:'#22c55e',BwF:'#f97316',CZNS:'#c8d6e0',GLDY:'#ef4444'};
  document.getElementById('chartAlliance').innerHTML = sorted.slice(0,8).map(([tag,c])=>`
    <div class="bar-row"><div class="bar-name">[${tag}]</div>
    <div class="bar-track"><div class="bar-fill" style="width:${(c/max*100).toFixed(1)}%;background:${colors[tag]||'var(--blue)'}"></div></div>
    <div class="bar-count">${c}</div></div>`).join('') || `<div style="color:var(--dim);font-size:12px">${UI[lang].noData}</div>`;
}

function buildDonut() {
  const m={g:0,p:0,b:0,w:0};
  allRows.forEach(r=>{const k=seatKey(r.seat);if(k)m[k]++;});
  const total=allRows.length||1;
  const colors={g:'#f0b429',p:'#9b5de5',b:'#00b4d8',w:'#c8d6e0'};
  const labels={g:'Elite',p:'Contributor',b:'Pioneer',w:'Follower'};
  const R=38,CX=50,CY=50,sw=14;
  let start=-Math.PI/2,paths='',leg='';
  Object.entries(m).forEach(([k,c])=>{
    if(!c)return;
    const a=c/total*Math.PI*2;
    const x1=CX+R*Math.cos(start),y1=CY+R*Math.sin(start);
    const x2=CX+R*Math.cos(start+a),y2=CY+R*Math.sin(start+a);
    paths+=`<path d="M${x1.toFixed(2)},${y1.toFixed(2)} A${R},${R} 0 ${a>Math.PI?1:0},1 ${x2.toFixed(2)},${y2.toFixed(2)}" fill="none" stroke="${colors[k]}" stroke-width="${sw}"/>`;
    leg+=`<div class="dl-row"><div class="dl-dot" style="background:${colors[k]}"></div><div class="dl-label">${labels[k]}</div><div class="dl-val">${c}</div></div>`;
    start+=a;
  });
  document.getElementById('donutSvg').innerHTML=`<circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="rgba(255,255,255,.04)" stroke-width="${sw}"/>${paths}<text x="${CX}" y="${CY+1}" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-family="Syne" font-size="14" font-weight="800">${allRows.length}</text>`;
  document.getElementById('donutLegend').innerHTML=leg||`<div style="color:var(--dim);font-size:11px">${UI[lang].noData}</div>`;
}

function buildSparkline() {
  const counts=[],labels=[];
  const locale=lang==='de'?'de-DE':lang==='fr'?'fr-FR':lang==='en'?'en-GB':'it-IT';
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    counts.push(allRows.filter(r=>r.ts&&r.ts.startsWith(d.toISOString().slice(0,10))).length);
    labels.push(d.toLocaleDateString(locale,{weekday:'short'}));
  }
  const max=Math.max(...counts,1);
  const W=200,H=70,pad=8,bw=(W-pad*8)/7;
  let bars='';
  counts.forEach((c,i)=>{
    const x=pad+i*(bw+pad),h=(c/max)*(H-16),y=H-h-4;
    bars+=`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${bw.toFixed(1)}" height="${Math.max(h,2).toFixed(1)}" fill="var(--blue)" opacity="${c?0.8:0.15}" rx="1"/>`;
    if(c) bars+=`<text x="${(x+bw/2).toFixed(1)}" y="${(y-3).toFixed(1)}" text-anchor="middle" fill="var(--text)" font-size="7" font-family="JetBrains Mono">${c}</text>`;
  });
  document.getElementById('sparkSvg').innerHTML=bars;
  document.getElementById('sparkLabels').innerHTML=labels.map(l=>`<span style="font-family:var(--font-m);font-size:9px;color:var(--dim)">${l}</span>`).join('');
}

function getFiltered() {
  const search=document.getElementById('searchInput').value.toLowerCase().trim();
  return allRows.filter(r=>{
    if(filters.seat!=='all'&&!r.seat.toUpperCase().includes(filters.seat))return false;
    if(filters.alliance!=='all'&&r.alliance!==filters.alliance)return false;
    if(filters.status!=='all'&&r.status!==filters.status)return false;
    if(search&&!r.nickname.toLowerCase().includes(search))return false;
    return true;
  });
}

function renderTable() {
  const t = UI[lang];
  let rows = getFiltered();
  rows.sort((a,b)=>{
    let va=a[sortCol]??'',vb=b[sortCol]??'';
    if(sortCol==='power'){va=+va;vb=+vb;}
    if(va<vb)return sortAsc?-1:1; if(va>vb)return sortAsc?1:-1; return 0;
  });
  document.getElementById('tableCount').textContent=`(${rows.length} / ${allRows.length})`;
  if(!rows.length){document.getElementById('tableBody').innerHTML=`<tr><td colspan="8" class="state-row">${t.noData}</td></tr>`;return;}
  document.getElementById('tableBody').innerHTML=rows.map((r,i)=>`
    <tr>
      <td class="td-ts">${i+1}</td>
      <td><span class="td-nick">${esc(r.nickname)}</span><br><span class="td-ts">${r.ts?.slice(0,10)||''}</span></td>
      <td class="td-power">${fmtPower(r.power)}</td>
      <td class="td-server">${esc(r.server)}</td>
      <td>${seatBadge(r.seat)}</td>
      <td><span class="ally-tag">[${esc(r.alliance)}]</span><br><span style="font-size:11px;color:var(--dim2)">${esc(r.allianceName)}</span></td>
      <td>${statusBadge(r.status, t)}</td>
      <td><button class="act-btn" onclick="openModal(${r._id})">${t.btnDetails}</button></td>
    </tr>`).join('');
}

function setFilter(type,val,btn){
  filters[type]=val;
  if(btn&&type==='seat'){document.querySelectorAll('[data-filter="seat"]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
  renderTable();
}

function sortBy(col){
  if(sortCol===col)sortAsc=!sortAsc;else{sortCol=col;sortAsc=false;}
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){
  const r=allRows.find(x=>x._id===id); if(!r)return;
  const t=UI[lang];
  const lMap={it:'ğŸ‡®ğŸ‡¹ IT',fr:'ğŸ‡«ğŸ‡· FR',en:'ğŸ‡¬ğŸ‡§ EN',de:'ğŸ‡©ğŸ‡ª DE'};
  document.getElementById('modalTitle').textContent=r.nickname;
  document.getElementById('modalBody').innerHTML=`
    <div class="detail-item"><div class="detail-key">${t.modalPower}</div><div class="detail-val">${fmtPower(r.power)}</div></div>
    <div class="detail-item"><div class="detail-key">${t.modalSeat}</div><div class="detail-val">${seatBadge(r.seat)}</div></div>
    <div class="detail-item"><div class="detail-key">${t.modalServer}</div><div class="detail-val">${esc(r.server)}</div></div>
    <div class="detail-item"><div class="detail-key">${t.modalLang}</div><div class="detail-val">${lMap[r.lang]||r.lang}</div></div>
    <div class="detail-item"><div class="detail-key">${t.modalAlly}</div><div class="detail-val"><span class="ally-tag">[${esc(r.alliance)}]</span> ${esc(r.allianceName)}</div></div>
    <div class="detail-item"><div class="detail-key">${t.modalIntent}</div><div class="detail-val">${t.intentMap[r.intent]||'â€”'}</div></div>
    <div class="detail-item full"><div class="detail-key">${t.modalBio}</div><div class="detail-val" style="font-size:13px;line-height:1.5;font-weight:400">${esc(r.bio)||'<em style="color:var(--dim)">'+t.modalNoBio+'</em>'}</div></div>
    <div class="detail-item full"><div class="detail-key">${t.modalStatus}</div><div class="detail-val">${statusBadge(r.status,t)}</div></div>
    <div class="detail-item full"><div class="detail-key">${t.modalNotes}</div><div class="detail-val" style="font-size:13px;font-weight:400">${esc(r.notes)||'<em style="color:var(--dim)">'+t.modalNoNotes+'</em>'}</div></div>
    <div class="detail-item full"><div class="detail-key">${t.modalDate}</div><div class="detail-val" style="font-family:var(--font-m);font-size:12px">${r.ts}</div></div>`;
  document.getElementById('modalActions').innerHTML=`
    <button class="mact mact-ok"  onclick="updateStatus(${id},'In attesa'===UI[lang].stWait?'In attesa':'In attesa')">${t.btnAccept}</button>
    <button class="mact mact-ok"  onclick="updateStatus(${id},'Accettato')">${t.btnAccept}</button>
    <button class="mact mact-no"  onclick="updateStatus(${id},'Rifiutato')">${t.btnReject}</button>
    <button class="mact mact-rev" onclick="updateStatus(${id},'In valutazione')">${t.btnReview}</button>`;
  // Fix: clean modal actions
  document.getElementById('modalActions').innerHTML=`
    <button class="mact mact-ok"  onclick="updateStatus(${id},'Accettato')">${t.btnAccept}</button>
    <button class="mact mact-no"  onclick="updateStatus(${id},'Rifiutato')">${t.btnReject}</button>
    <button class="mact mact-rev" onclick="updateStatus(${id},'In valutazione')">${t.btnReview}</button>`;
  document.getElementById('modal').classList.add('open');
}

function closeModal(){document.getElementById('modal').classList.remove('open');}

async function updateStatus(id,newStatus){
  const r=allRows.find(x=>x._id===id); if(!r)return;
  r.status=newStatus; closeModal(); renderTable(); updateKPIs();
  showToast(UI[lang].stOk + ' â†’ ' + newStatus, 'ok');
  try {
    await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'updateStatus',rowIndex:id+2,status:newStatus})});
  } catch(e){console.warn(e);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initEditor() {
  const row=document.getElementById('allyTabsRow');
  if(!row.children.length) {
    ALLIANCES.forEach(a=>{
      const b=document.createElement('button'); b.className='ally-tab'+(a.tag===currentAllyTag?' active':'');
      b.textContent=`[${a.tag}]`; b.onclick=()=>selectAlliance(a.tag); b.id='atab-'+a.tag;
      row.appendChild(b);
    });
  }
  renderEditorCard();
}

function selectAlliance(tag){
  if(unsavedChanges&&!confirm('Modifiche non salvate. Continuare?'))return;
  currentAllyTag=tag; unsavedChanges=false;
  document.querySelectorAll('.ally-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('atab-'+tag)?.classList.add('active');
  renderEditorCard();
}

function renderEditorCard(){
  const ally=ALLIANCES.find(a=>a.tag===currentAllyTag); if(!ally)return;
  const t=UI[lang];
  document.getElementById('edTag').textContent='['+ally.tag+']';
  document.getElementById('edName').textContent=ally.name;
  document.getElementById('edRank').textContent=ally.rank;
  const texts=allianceTexts[currentAllyTag]||{};
  const it=texts.it||{};
  document.getElementById('srcReq').value=it.req||'';
  document.getElementById('srcDesc').value=it.desc||'';
  document.getElementById('srcReq').oninput=()=>{unsavedChanges=true;};
  document.getElementById('srcDesc').oninput=()=>{unsavedChanges=true;};
  renderTransGrid(texts);
  document.getElementById('saveInfo').textContent=t.saveInfo;
  document.getElementById('lastSaved').textContent=texts._saved?('ğŸ’¾ '+texts._saved):'';
  document.getElementById('translateStatus').textContent=t.translateWaiting;
  document.getElementById('translateStatus').className='translate-status';
}

function renderTransGrid(texts){
  const grid=document.getElementById('transGrid'); grid.innerHTML='';
  LANGS_EDITOR.forEach(({code,flag,label})=>{
    const tx=(texts[code])||{};
    const hasContent=!!(tx.req||tx.desc);
    const card=document.createElement('div');
    card.className='trans-card'+(hasContent?' has-content':'');
    card.id='tcard-'+code;
    card.innerHTML=`
      <div class="trans-card-header">
        <span class="trans-flag">${flag}</span>
        <span class="trans-lang">${label}</span>
        ${code!=='it'?`<button onclick="editTranslation('${code}')" style="margin-left:auto;font-family:var(--font-m);font-size:9px;padding:3px 8px;border:1px solid var(--border);background:transparent;color:var(--dim2);cursor:pointer;">âœ</button>`:''}
      </div>
      <div id="tview-${code}">
        <div class="trans-field"><div class="trans-field-label">${UI[lang].srcReqLabel}</div><div class="trans-field-text" id="treq-${code}">${esc(tx.req)||'<span class="trans-empty">â€”</span>'}</div></div>
        <div class="trans-field"><div class="trans-field-label">${UI[lang].srcDescLabel}</div><div class="trans-field-text" id="tdesc-${code}">${esc(tx.desc)||'<span class="trans-empty">â€”</span>'}</div></div>
      </div>
      <div id="tedit-${code}" style="display:none;">
        <div class="trans-field"><div class="trans-field-label">${UI[lang].srcReqLabel}</div><textarea class="trans-edit" id="tedit-req-${code}" rows="2">${esc(tx.req||'')}</textarea></div>
        <div class="trans-field"><div class="trans-field-label">${UI[lang].srcDescLabel}</div><textarea class="trans-edit" id="tedit-desc-${code}" rows="2">${esc(tx.desc||'')}</textarea></div>
        <button onclick="saveInlineEdit('${code}')" style="margin-top:6px;font-family:var(--font-m);font-size:9px;padding:4px 10px;border:1px solid rgba(34,197,94,.4);background:transparent;color:var(--green);cursor:pointer;">âœ“</button>
        <button onclick="cancelInlineEdit('${code}')" style="margin-top:6px;margin-left:4px;font-family:var(--font-m);font-size:9px;padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--dim2);cursor:pointer;">âœ•</button>
      </div>`;
    grid.appendChild(card);
  });
}

function editTranslation(code){document.getElementById('tview-'+code).style.display='none';document.getElementById('tedit-'+code).style.display='block';}
function cancelInlineEdit(code){document.getElementById('tview-'+code).style.display='block';document.getElementById('tedit-'+code).style.display='none';}
function saveInlineEdit(code){
  const req=document.getElementById('tedit-req-'+code).value.trim();
  const desc=document.getElementById('tedit-desc-'+code).value.trim();
  if(!allianceTexts[currentAllyTag])allianceTexts[currentAllyTag]={};
  allianceTexts[currentAllyTag][code]={req,desc};
  document.getElementById('treq-'+code).innerHTML=esc(req)||'<span class="trans-empty">â€”</span>';
  document.getElementById('tdesc-'+code).innerHTML=esc(desc)||'<span class="trans-empty">â€”</span>';
  document.getElementById('tview-'+code).style.display='block';
  document.getElementById('tedit-'+code).style.display='none';
  document.getElementById('tcard-'+code).classList.add('has-content');
  unsavedChanges=true; showToast('âœ“ '+code.toUpperCase(),'ok');
}

async function translateAll(){
  const req=document.getElementById('srcReq').value.trim();
  const desc=document.getElementById('srcDesc').value.trim();
  const t=UI[lang];
  if(!req&&!desc){showToast('âš  '+t.srcReqLabel,'warn');return;}
  const btn=document.getElementById('btnTranslate');
  const status=document.getElementById('translateStatus');
  btn.disabled=true; btn.textContent=t.translateLoading;
  status.className='translate-status loading'; status.textContent=t.translateLoading;
  if(!allianceTexts[currentAllyTag])allianceTexts[currentAllyTag]={};
  allianceTexts[currentAllyTag]['it']={req,desc};
  try{
    // URLSearchParams encode la virgola in %2C â€” costruiamo l'URL manualmente
    const tUrl=SCRIPT_URL
      +'?action=translateTexts'
      +'&tag='+encodeURIComponent(currentAllyTag)
      +'&sourceReq='+encodeURIComponent(req)
      +'&sourceDesc='+encodeURIComponent(desc)
      +'&sourceLang=it'
      +'&targetLangs=fr,en,de'
      +'&t='+Date.now();
    const res=await fetch(tUrl);
    const json=await res.json();
    if(!json.success)throw new Error(json.error);
    Object.entries(json.translations||{}).forEach(([code,tx])=>{allianceTexts[currentAllyTag][code]=tx;});
    renderTransGrid(allianceTexts[currentAllyTag]);
    status.className='translate-status done'; status.textContent=t.translateDone;
    unsavedChanges=true;
  }catch(err){
    status.className='translate-status err'; status.textContent='âš  '+err.message;
  }finally{
    btn.disabled=false; btn.textContent=t.btnTranslate;
  }
}

function resetEditor(){if(!confirm('Reset?'))return;unsavedChanges=false;renderEditorCard();}

async function saveAllianceTexts(){
  const texts=allianceTexts[currentAllyTag];
  if(!texts){showToast('âš ','warn');return;}
  const btn=document.querySelector('.btn-green'); btn.disabled=true;
  try{
    const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'saveAllianceTexts',tag:currentAllyTag,texts:{it:texts.it||{},fr:texts.fr||{},en:texts.en||{},de:texts.de||{}}})});
    const json=await res.json();
    if(!json.success)throw new Error(json.error);
    const saved=new Date().toLocaleString();
    allianceTexts[currentAllyTag]._saved=saved;
    unsavedChanges=false;
    document.getElementById('lastSaved').textContent='ğŸ’¾ '+saved;
    document.getElementById('saveInfo').textContent=UI[lang].translateDone;
    showToast('âœ… ['+currentAllyTag+']','ok');
  }catch(err){showToast('âš  '+err.message,'err');}
  finally{btn.disabled=false;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){
  const rows=getFiltered();
  const h=['Timestamp','Lingua','Nickname','Potenza','Server','Sedia','Intent','Alleanza','Nome','Bio','Stato','Note'];
  const lines=[h.join(',')];
  rows.forEach(r=>lines.push([r.ts,r.lang,r.nickname,r.power,r.server,r.seat,r.intent,r.alliance,r.allianceName,`"${(r.bio||'').replace(/"/g,'""')}"`,r.status,r.notes].join(',')));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}));
  a.download=`NGC_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seatKey(s=''){s=s.toUpperCase();if(s.includes('ELITE'))return'g';if(s.includes('CONTRIBUTOR'))return'p';if(s.includes('PIONEER'))return'b';if(s.includes('FOLLOWER'))return'w';return'';}
function seatBadge(s=''){const k=seatKey(s);const ic={g:'ğŸ‘‘',p:'ğŸŸ£',b:'ğŸ”µ',w:'ğŸª‘'};const cl={g:'sb-g',p:'sb-p',b:'sb-b',w:'sb-w'};if(!k)return`<span style="color:var(--dim)">â€”</span>`;return`<span class="seat-badge ${cl[k]}">${ic[k]} ${s.replace(' âš¡','')}</span>`;}
function statusBadge(s='',t){
  t=t||UI[lang];
  const map={'In attesa':['st-wait',t.stWait],'Accettato':['st-ok',t.stOk],'Rifiutato':['st-no',t.stNo],'In valutazione':['st-rev',t.stRev]};
  const [cls,label]=map[s]||['st-wait',t.stWait];
  return`<span class="status-badge ${cls}">${label}</span>`;
}
function fmtPower(p){if(!p)return'â€”';const n=parseInt(p);if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(1)+'M';return n.toLocaleString();}
function esc(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function set(id,val){const el=document.getElementById(id);if(el)el.textContent=val;}
function showToast(msg,type='ok'){
  const t=document.getElementById('toast'); t.textContent=msg;
  t.style.color=type==='ok'?'var(--green)':type==='warn'?'var(--gold)':'var(--red)';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setLang('it');
loadData();
setInterval(loadData, 120000);
</script>
</body>
</html>
